<!-- âœ… Add-only: global station keyword search (lower-48) -->
<script>
(function(){
  // Bail out if the search UI isn't present (keeps this add-on harmless)
  const input = document.getElementById('global-search');
  const box   = document.getElementById('search-results');
  if (!input || !box) return;

  const LOWER48 = [
    "AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY",
    "LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM",
    "NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA",
    "WI","WV","WY"
  ];

  const index = []; // {id,name,state,norm}
  let built = false, building = false;

  // Build nationwide index after load, in small batches (won't block UI)
  window.addEventListener('DOMContentLoaded', () => {
    if (building || built) return;
    building = true;
    const batchSize = 6;
    (async () => {
      try {
        for (let i = 0; i < LOWER48.length; i += batchSize) {
          const batch = LOWER48.slice(i, i + batchSize);
          await Promise.all(batch.map(async (st) => {
            const url = `https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${st}&parameterCd=00065&siteStatus=active`;
            const txt = await fetch(url).then(r => r.text()).catch(()=>null);
            if (!txt) return;
            const lines = txt.split('\n');
            const headerIdx = lines.findIndex(l => l.startsWith('agency_cd'));
            for (let j = (headerIdx === -1 ? 0 : headerIdx + 1); j < lines.length; j++) {
              const line = lines[j];
              if (!line || line[0] === '#') continue;
              const parts = line.split('\t');
              if (parts.length < 3) continue;
              const id = parts[1], name = parts[2];
              if (!id || !name) continue;
              index.push({ id, name, state: st, norm: name.toLowerCase() });
            }
          }));
        }
        built = true;
      } catch(e) {
        console.warn('Global index build error:', e);
      } finally {
        building = false;
      }
    })();
  });

  // Debounced search
  const debounce = (fn, ms=150) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

  const render = (items) => {
    if (!items.length) { box.style.display='none'; box.innerHTML=''; return; }
    box.style.display='block';
    box.innerHTML = items.slice(0,150).map(it => `
      <button type="button" data-id="${it.id}" data-state="${it.state}"
        style="display:block;width:100%;text-align:left;padding:8px 10px;margin:4px 0;
               background:#294a38;color:#ddd;border:none;border-radius:6px;cursor:pointer;">
        ${it.name} (${it.state})
      </button>
    `).join('');
    box.querySelectorAll('button').forEach(btn => {
      btn.onmouseenter = () => btn.style.background = '#3f6d4e';
      btn.onmouseleave = () => btn.style.background = '#294a38';
      btn.onclick = () => choose({ id: btn.dataset.id, state: btn.dataset.state });
    });
  };

  const doSearch = debounce(() => {
    const q = (input.value || '').trim().toLowerCase();
    if (!q) { box.style.display='none'; box.innerHTML=''; return; }
    const tokens = q.split(/\s+/).filter(Boolean);
    const results = index.filter(s =>
      tokens.every(t => s.norm.includes(t) || s.id.includes(t))
    );
    render(results);
  }, 160);

  input.addEventListener('focus', doSearch);
  input.addEventListener('input', doSearch);
  document.addEventListener('click', (e) => {
    const wrap = document.getElementById('global-search-wrap');
    if (wrap && !wrap.contains(e.target)) { box.style.display='none'; }
  });

  // Choose from results: set state -> load stations -> select station -> run existing showChart()
  async function choose(item){
    try {
      const stateSel   = document.getElementById('state-select');
      const stationSel = document.getElementById('station-select');
      const searchBtn  = document.getElementById('search-btn');
      if (!stateSel || !stationSel) return;

      if (stateSel.value !== item.state) {
        stateSel.value = item.state;
        if (typeof fetchStations === 'function') {
          await fetchStations(); // your existing function
        } else {
          stateSel.dispatchEvent(new Event('change'));
        }
      }

      await waitFor(() =>
        Array.from(stationSel.options).some(o => o.value === item.id), 15000);

      stationSel.value = item.id;
      if (typeof stationSel.onchange === 'function') stationSel.onchange();
      if (searchBtn) searchBtn.disabled = false;

      box.style.display='none'; input.value = '';
      if (typeof showChart === 'function') showChart(); // reuse your logic
    } catch(e){ console.warn('choose error', e); }
  }

  function waitFor(testFn, timeoutMs=15000){
    return new Promise((res, rej) => {
      const t0 = Date.now();
      const iv = setInterval(() => {
        if (testFn()) { clearInterval(iv); res(true); }
        else if (Date.now() - t0 > timeoutMs) { clearInterval(iv); rej(new Error('timeout')); }
      }, 120);
    });
  }
})();
</script>

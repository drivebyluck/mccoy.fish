<script>
/**
 * DROP-IN: All 48-state river keyword search that fills your second dropdown.
 * Zero CSS changes. No removals. Uses USGS site service.
 * If your IDs differ, change KEYWORD_INPUT_ID and STATION_SELECT_ID below.
 */

/* ====== CONFIG: set these two to match your page ====== */
const KEYWORD_INPUT_ID = "keywordInput";   // your text input for keyword search
const STATION_SELECT_ID = "stationSelect"; // your second dropdown for stations

/* ====== 48 contiguous states (no AK, HI) ====== */
const STATE_CODES_48 = [
  "AL","AZ","AR","CA","CO","CT","DE","FL","GA","ID","IL","IN","IA","KS","KY","LA",
  "ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND",
  "OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"
];

/* ====== USGS helpers ====== */
const USGS_SITE_URL = "https://waterservices.usgs.gov/nwis/site/";
/* We pull sites that have instantaneous values for stage/discharge and are stream gages. */
const BASE_PARAMS = "format=json&hasDataTypeCd=iv&siteType=ST&parameterCd=00060,00065";

/* Debounce so we do not spam the API while typing */
function debounce(fn, ms) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

/* Trim option labels to avoid super wide text; no CSS changes */
function trimLabel(s, max = 72) { return s.length > max ? s.slice(0, max - 1) + "…" : s; }

/* Build a friendly label for a station option */
function labelForStation(st, site) {
  const name = site.siteName || site.name || "";
  const code = site.siteCode?.[0]?.value || site.code || "";
  const county = site.countyCd ? ` • County ${site.countyCd}` : "";
  return trimLabel(`${name} — ${st} (${code})${county}`);
}

/* Merge, dedupe by site code, and sort by state then name */
function dedupeAndSort(stationArr) {
  const seen = new Map();
  for (const s of stationArr) {
    const code = s.siteCode?.[0]?.value;
    if (!code) continue;
    if (!seen.has(code)) seen.set(code, s);
  }
  return Array.from(seen.values()).sort((a, b) => {
    const an = (a.siteName || "").toLowerCase();
    const bn = (b.siteName || "").toLowerCase();
    return an.localeCompare(bn);
  });
}

/* Fetch one state’s sites and filter by keyword on the client side */
async function fetchStateSitesFiltered(stateCd, keyword) {
  const url = `${USGS_SITE_URL}?${BASE_PARAMS}&stateCd=${stateCd}`;
  try {
    const res = await fetch(url);
    if (!res.ok) return [];
    const json = await res.json();
    const sites = json?.value?.timeSeries?.map(ts => ts?.sourceInfo) || [];
    if (!keyword) return sites;

    const kw = keyword.toLowerCase();
    return sites.filter(s => {
      const name = (s.siteName || "").toLowerCase();
      return name.includes(kw);
    });
  } catch {
    return [];
  }
}

/* Controller to cancel previous keyword searches */
let lastSearchController = null;

/* Main: search all 48 states and populate the station dropdown */
async function searchRiversAllStates(keyword) {
  const select = document.getElementById(STATION_SELECT_ID);
  if (!select) return;

  // Clear and show a loading option
  select.innerHTML = "";
  const loadingOpt = document.createElement("option");
  loadingOpt.value = "";
  loadingOpt.textContent = keyword ? `Searching “${keyword}” across 48 states…` : "Type a river name to search all states…";
  select.appendChild(loadingOpt);

  // Abort previous in-flight search
  if (lastSearchController) lastSearchController.abort();
  lastSearchController = new AbortController();
  const { signal } = lastSearchController;

  try {
    const tasks = STATE_CODES_48.map(st => fetchStateSitesFiltered(st, keyword));
    const results = await Promise.allSettled(tasks);

    if (signal.aborted) return; // ignored, a newer search started

    let stations = [];
    results.forEach(r => {
      if (r.status === "fulfilled") stations = stations.concat(r.value || []);
    });

    stations = dedupeAndSort(stations);

    // Refill the select
    select.innerHTML = "";
    if (stations.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No matches found.";
      select.appendChild(opt);
      return;
    }

    // Limit to a reasonable count so the list stays usable
    const MAX = 300;
    for (let i = 0; i < Math.min(MAX, stations.length); i++) {
      const s = stations[i];
      const code = s.siteCode?.[0]?.value;
      const st = s.siteCode?.[0]?.agencyCode ? "" : ""; // placeholder if you ever add per-state label from metadata
      const opt = document.createElement("option");
      opt.value = code || "";
      opt.textContent = labelForStation(st, s);
      select.appendChild(opt);
    }
  } catch {
    select.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Search failed. Try again.";
    select.appendChild(opt);
  }
}

/* Wire up your keyword input with debounce */
function initAllStatesKeywordSearch() {
  const input = document.getElementById(KEYWORD_INPUT_ID);
  const select = document.getElementById(STATION_SELECT_ID);
  if (!input || !select) return; // IDs not found, do nothing

  const onType = debounce(() => {
    const q = input.value.trim();
    if (q.length === 0) {
      // Empty keyword: leave your existing state-based flow alone.
      // We just reset the second dropdown label, but do not remove your items if you already fill them elsewhere.
      select.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Type a river name to search all states…";
      select.appendChild(opt);
      return;
    }
    searchRiversAllStates(q);
  }, 350);

  input.addEventListener("input", onType);

  // Initial placeholder
  if (!select.options.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Type a river name to search all states…";
    select.appendChild(opt);
  }
}

/* Auto-init after page loads */
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initAllStatesKeywordSearch);
} else {
  initAllStatesKeywordSearch();
}
</script>

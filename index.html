<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>McCoy.fish</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      background-image: url('mccoyfishwallpaper.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      background-repeat: no-repeat;
      color: #d6d6d6;
    }
    header {
      text-align: center;
      padding-top: 40px;
    }
    header img {
      max-width: 160px;
      height: auto;
    }
    h1 {
      font-size: 3em;
      margin: 10px 0;
      color: #ccc;
    }
    main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .search-section {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px;
      box-shadow: 0 0 20px #003300;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      margin-top: 20px;
    }
    .search-section h2 {
      text-align: center;
      font-size: 1.7em;
      color: #b8ffb3;
      margin-bottom: 20px;
    }
    .search-section input,
    .search-section select,
    .search-section button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      background-color: #294a38;
      color: #ddd;
    }
    .search-section button {
      background-color: #3f6d4e;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .search-section button:hover {
      background-color: #51996b;
    }
    .gage-section {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px;
      box-shadow: 0 0 20px #003300;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      margin-top: 20px;
      display: none;
    }
    .gage-section h2 {
      color: #b8ffb3;
      text-align: center;
    }
    footer {
      text-align: center;
      padding: 30px 0 20px 0;
      font-size: 0.9em;
      color: #ccc;
    }
  </style>
</head>
<body>
  <header>
    <img src="mccoyfishlogo.png" alt="McCoy Fish Logo" />
    <h1>McCoy.fish</h1>
  </header>

  <main>
    <section class="search-section">
      <h2>Search Water Data</h2>

      <!-- ===== ADD-ONLY: standalone keyword search (independent of dropdowns) ===== -->
      <div id="global-search-wrap" style="margin-top: -5px; margin-bottom: 12px;">
        <input id="global-search" type="text"
               placeholder="Keyword search all stations (lower 48)…"
               style="width:100%;padding:12px;border:none;border-radius:8px;background:#294a38;color:#ddd;">
        <div id="search-results"
             style="display:none;position:relative;max-height:220px;overflow:auto;margin-top:6px;"></div>
      </div>
      <!-- ===== END ADD-ONLY ===== -->

      <select id="state-select" onchange="fetchStations()">
        <option value="">Select a state</option>
        <option value="AL">Alabama</option><option value="AR">Arkansas</option><option value="AZ">Arizona</option>
        <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option>
        <option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option>
        <option value="IA">Iowa</option><option value="ID">Idaho</option><option value="IL">Illinois</option>
        <option value="IN">Indiana</option><option value="KS">Kansas</option><option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option><option value="MA">Massachusetts</option><option value="MD">Maryland</option>
        <option value="ME">Maine</option><option value="MI">Michigan</option><option value="MN">Minnesota</option>
        <option value="MO">Missouri</option><option value="MS">Mississippi</option><option value="MT">Montana</option>
        <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="NE">Nebraska</option>
        <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option>
        <option value="NV">Nevada</option><option value="NY">New York</option><option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option>
        <option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
        <option value="VA">Virginia</option><option value="VT">Vermont</option><option value="WA">Washington</option>
        <option value="WI">Wisconsin</option><option value="WV">West Virginia</option><option value="WY">Wyoming</option>
      </select>

      <select id="station-select" disabled>
        <option value="">Select a station</option>
      </select>

      <button onclick="showChart()" id="search-btn" disabled>Search</button>
    </section>

<section class="gage-section" id="chart-section">
  <h2>Gage Height Chart</h2>
  <img id="usgs-chart-img" style="width: 100%; height: auto;" alt="USGS Gage Height Chart" />
  
  <h2 style="margin-top: 30px;">Discharge (CFS) – Last 7 Days</h2>
  <img id="usgs-discharge-img" style="width: 100%; height: auto;" alt="USGS Discharge Chart" />
</section>

  </main>

  <script>
    async function fetchStations() {
      const state = document.getElementById("state-select").value;
      const stationSelect = document.getElementById("station-select");
      const searchBtn = document.getElementById("search-btn");

      stationSelect.innerHTML = '<option value="">Loading stations...</option>';
      stationSelect.disabled = true;
      searchBtn.disabled = true;

      if (!state) return;

      const response = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${state}&parameterCd=00065`);
      const text = await response.text();

      const lines = text.split('\n').filter(line => !line.startsWith('#') && line.trim() && !line.startsWith('agency_cd'));
      let stations = lines.map(line => {
        const parts = line.split('\t');
        return { id: parts[1], name: parts[2] };
      });

      // Sort stations alphabetically by name
      stations.sort((a, b) => a.name.localeCompare(b.name));

      stationSelect.innerHTML = '<option value="">Select a station</option>';
      stations.forEach(station => {
        const option = document.createElement('option');
        option.value = station.id;
        option.textContent = station.name;
        stationSelect.appendChild(option);
      });

      stationSelect.disabled = false;
      stationSelect.onchange = () => {
        searchBtn.disabled = stationSelect.value === "";
      };
    }

function showChart() {
  const siteId = document.getElementById("station-select").value;
  if (!siteId) return;

  const chartSection = document.getElementById("chart-section");
  chartSection.style.display = 'block';

  // Dates
  const today = new Date();
  const endDate = today.toISOString().split('T')[0];

  const past = new Date();
  past.setDate(today.getDate() - 7);
  const startDate = past.toISOString().split('T')[0];

  // Gage Height Chart
  const chartImg = document.getElementById("usgs-chart-img");
  chartImg.src = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${siteId}&parm_cd=00065&period=7`;

  // Discharge Chart with correct date range
  const dischargeImg = document.getElementById("usgs-discharge-img");
  dischargeImg.src = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${siteId}&parm_cd=00060&begin_date=${startDate}&end_date=${endDate}`;
}

  </script>

  <!-- ===== ADD-ONLY: nationwide keyword search index + wiring (safe/guarded) ===== -->
  <script>
  (function(){
    'use strict';
    const input = document.getElementById('global-search');
    const box   = document.getElementById('search-results');
    if (!input || !box) return; // do nothing if the search UI wasn't added

    const LOWER48 = [
      "AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY",
      "LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM",
      "NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA",
      "WI","WV","WY"
    ];
    const index = []; // { id, name, state, norm }
    let built = false, building = false;

    // Build the index in small batches after load (doesn't touch existing flow)
    window.addEventListener('DOMContentLoaded', () => {
      if (building || built) return;
      building = true;
      const batchSize = 6;

      (async () => {
        try {
          for (let i = 0; i < LOWER48.length; i += batchSize) {
            const batch = LOWER48.slice(i, i + batchSize);
            await Promise.all(batch.map(async (st) => {
              const url = `https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${st}&parameterCd=00065&siteStatus=active`;
              let txt;
              try { txt = await fetch(url, {cache:'no-store'}).then(r=>r.text()); } catch { return; }
              const lines = txt.split('\n');
              const headerIdx = lines.findIndex(l => l.startsWith('agency_cd'));
              for (let j = (headerIdx === -1 ? 0 : headerIdx + 1); j < lines.length; j++) {
                const line = lines[j];
                if (!line || line[0] === '#') continue;
                const parts = line.split('\t');
                if (parts.length < 3) continue;
                const id = parts[1], name = parts[2];
                if (!id || !name) continue;
                index.push({ id, name, state: st, norm: name.toLowerCase() });
              }
            }));
          }
          built = true;
        } finally { building = false; }
      })();
    });

    // Debounce helper
    const debounce = (fn, ms=160) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

    const render = (items) => {
      if (!items.length) { box.style.display='none'; box.innerHTML=''; return; }
      box.style.display='block';
      box.innerHTML = items.slice(0, 200).map(it => `
        <button type="button" data-id="${it.id}" data-state="${it.state}"
          style="display:block;width:100%;text-align:left;padding:8px 10px;margin:4px 0;
                 background:#294a38;color:#ddd;border:none;border-radius:6px;cursor:pointer;">
          ${it.name} (${it.state})
        </button>
      `).join('');
      box.querySelectorAll('button').forEach(btn => {
        btn.onmouseenter = () => btn.style.background = '#3f6d4e';
        btn.onmouseleave = () => btn.style.background = '#294a38';
        btn.onclick = () => choose({ id: btn.dataset.id, state: btn.dataset.state });
      });
    };

    const doSearch = debounce(() => {
      const q = (input.value || '').trim().toLowerCase();
      if (!q) { box.style.display='none'; box.innerHTML=''; return; }
      if (!built && index.length === 0) {
        box.style.display='block';
        box.innerHTML = `<div style="padding:10px;background:#294a38;border-radius:6px;">Loading stations…</div>`;
        return;
      }
      const tokens = q.split(/\s+/).filter(Boolean);
      const results = index.filter(s => tokens.every(t => s.norm.includes(t) || s.id.includes(t)));
      render(results);
    }, 160);

    input.addEventListener('focus', doSearch);
    input.addEventListener('input', doSearch);
    document.addEventListener('click', (e) => {
      const wrap = document.getElementById('global-search-wrap');
      if (wrap && !wrap.contains(e.target)) { box.style.display='none'; }
    });

    async function choose(item){
      const stateSel   = document.getElementById('state-select');
      const stationSel = document.getElementById('station-select');
      const searchBtn  = document.getElementById('search-btn');
      if (!stateSel || !stationSel) return;

      // 1) Set state and load its stations using your existing function
      if (stateSel.value !== item.state) {
        stateSel.value = item.state;
        if (typeof fetchStations === 'function') {
          await fetchStations();
        } else {
          stateSel.dispatchEvent(new Event('change'));
        }
      }

      // 2) Wait until the station appears in the state dropdown
      await waitFor(() => Array.from(stationSel.options).some(o => o.value === item.id), 15000);

      // 3) Select the station and enable your existing Search button
      stationSel.value = item.id;
      if (typeof stationSel.onchange === 'function') stationSel.onchange();
      if (searchBtn) searchBtn.disabled = false;

      // 4) Hide list, clear query, and reuse your existing showChart()
      box.style.display = 'none';
      input.value = '';
      if (typeof showChart === 'function') showChart();
    }

    function waitFor(testFn, timeoutMs=15000){
      return new Promise((resolve, reject) => {
        const t0 = Date.now();
        const iv = setInterval(() => {
          try {
            if (testFn()) { clearInterval(iv); resolve(true); return; }
            if (Date.now() - t0 > timeoutMs) { clearInterval(iv); reject(new Error('timeout')); }
          } catch(e){ clearInterval(iv); reject(e); }
        }, 120);
      });
    }
  })();
  </script>
  <!-- ===== END ADD-ONLY ===== -->

</body>
</html>

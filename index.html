<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>McCoy.fish</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      background-image: url('mccoyfishwallpaper.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      background-repeat: no-repeat;
      color: #d6d6d6;
    }
    header {
      text-align: center;
      padding-top: 40px;
    }
    header img {
      max-width: 160px;
      height: auto;
    }
    h1 {
      font-size: 2em;
      margin: 10px 0;
      color: #ccc;
    }
    main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .search-section {
      background-color: rgba(0, 20, 10, 0.5);
      border-radius: 15px;
      box-shadow: 0 0 20px #003300;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      margin-top: 20px;
    }
    .search-section h2 {
      text-align: center;
      font-size: 1.7em;
      color: #b8ffb3;
      margin-bottom: 20px;
    }
    .search-section input,
    .search-section select,
    .search-section button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      background-color: #294a38;
      color: #ddd;
    }
    .search-section button {
      background-color: #3f6d4e;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .search-section button:hover {
      background-color: #51996b;
    }
    .gage-section {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px;
      box-shadow: 0 0 20px #003300;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      margin-top: 20px;
      display: none;
    }
    .gage-section h2 {
      color: #b8ffb3;
      text-align: center;
    }
    footer {
      text-align: center;
      padding: 30px 0 20px 0;
      font-size: 0.9em;
      color: #ccc;
    }
  </style>
</head>
<body>
  <header>
    <img src="mccoyfishlogo.png" alt="McCoy Fish Logo" />
    <h1>US Rivers Height and Flow Tool</h1>
  </header>

  <main>
    <section class="search-section">
      <h2>Search Water Data</h2>

      <!-- âœ… ADDED: Global keyword search (independent of the dropdowns) -->
      <div id="global-search-wrap">
        <input id="global-search" type="text" placeholder="Quick search all stations: type river / station / city (lower 48)"/>
        <div id="search-results" style="display:none; max-height:240px; overflow:auto; background:#1b2c23; border-radius:8px; box-shadow:0 0 12px #003300; padding:6px;"></div>
      </div>
      <!-- ðŸ”š ADDED -->

      <select id="state-select" onchange="fetchStations()">
        <option value="">Select a state</option>
        <option value="AL">Alabama</option><option value="AR">Arkansas</option><option value="AZ">Arizona</option>
        <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option>
        <option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option>
        <option value="IA">Iowa</option><option value="ID">Idaho</option><option value="IL">Illinois</option>
        <option value="IN">Indiana</option><option value="KS">Kansas</option><option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option><option value="MA">Massachusetts</option><option value="MD">Maryland</option>
        <option value="ME">Maine</option><option value="MI">Michigan</option><option value="MN">Minnesota</option>
        <option value="MO">Missouri</option><option value="MS">Mississippi</option><option value="MT">Montana</option>
        <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="NE">Nebraska</option>
        <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option>
        <option value="NV">Nevada</option><option value="NY">New York</option><option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option>
        <option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
        <option value="VA">Virginia</option><option value="VT">Vermont</option><option value="WA">Washington</option>
        <option value="WI">Wisconsin</option><option value="WV">West Virginia</option><option value="WY">Wyoming</option>
      </select>

      <select id="station-select" disabled>
        <option value="">Select a station</option>
      </select>

      <button onclick="showChart()" id="search-btn" disabled>Search</button>
    </section>

<section class="gage-section" id="chart-section">
  <h2>Gage Height Chart</h2>
  <img id="usgs-chart-img" style="width: 100%; height: auto;" alt="USGS Gage Height Chart" />
  
  <h2 style="margin-top: 30px;">Discharge (CFS) â€“ Last 7 Days</h2>
  <img id="usgs-discharge-img" style="width: 100%; height: auto;" alt="USGS Discharge Chart" />
</section>

  </main>

  <script>
    async function fetchStations() {
      const state = document.getElementById("state-select").value;
      const stationSelect = document.getElementById("station-select");
      const searchBtn = document.getElementById("search-btn");

      stationSelect.innerHTML = '<option value="">Loading stations...</option>';
      stationSelect.disabled = true;
      searchBtn.disabled = true;

      if (!state) return;

      const response = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${state}&parameterCd=00065`);
      const text = await response.text();

      const lines = text.split('\n').filter(line => !line.startsWith('#') && line.trim() && !line.startsWith('agency_cd'));
      let stations = lines.map(line => {
        const parts = line.split('\t');
        return { id: parts[1], name: parts[2] };
      });

      // Sort stations alphabetically by name
      stations.sort((a, b) => a.name.localeCompare(b.name));

      stationSelect.innerHTML = '<option value="">Select a station</option>';
      stations.forEach(station => {
        const option = document.createElement('option');
        option.value = station.id;
        option.textContent = station.name;
        stationSelect.appendChild(option);
      });

      stationSelect.disabled = false;
      stationSelect.onchange = () => {
        searchBtn.disabled = stationSelect.value === "";
      };
    }

function showChart() {
  const siteId = document.getElementById("station-select").value;
  if (!siteId) return;

  const chartSection = document.getElementById("chart-section");
  chartSection.style.display = 'block';

  // Dates
  const today = new Date();
  const endDate = today.toISOString().split('T')[0];

  const past = new Date();
  past.setDate(today.getDate() - 7);
  const startDate = past.toISOString().split('T')[0];

  // Gage Height Chart
  const chartImg = document.getElementById("usgs-chart-img");
  chartImg.src = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${siteId}&parm_cd=00065&period=7`;

  // Discharge Chart with correct date range
  const dischargeImg = document.getElementById("usgs-discharge-img");
  dischargeImg.src = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${siteId}&parm_cd=00060&begin_date=${startDate}&end_date=${endDate}`;
}

  </script>

  <!-- âœ… ADDED: Global keyword search index + UI behavior (keeps your existing logic untouched) -->
  <script>
    // Lower-48 state codes matching your dropdown (excludes AK, HI)
    const LOWER48 = [
      "AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY",
      "LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM",
      "NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA",
      "WI","WV","WY"
    ];

    const stationIndex = []; // {id, name, state}
    let isIndexBuilding = false;
    let isIndexReady = false;

    const searchInput = document.getElementById('global-search');
    const resultsBox = document.getElementById('search-results');

    // Build index on first focus/type (background fetch of all states)
    async function buildGlobalIndex() {
      if (isIndexBuilding || isIndexReady) return;
      isIndexBuilding = true;
      try {
        for (const state of LOWER48) {
          const url = `https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${state}&parameterCd=00065`;
          const txt = await fetch(url).then(r => r.text());
          const lines = txt.split('\n').filter(line => !line.startsWith('#') && line.trim() && !line.startsWith('agency_cd'));
          for (const line of lines) {
            const parts = line.split('\t');
            const id = parts[1];
            const name = parts[2];
            if (id && name) stationIndex.push({ id, name, state });
          }
        }
        isIndexReady = true;
      } catch (e) {
        console.error('Global index build failed:', e);
      } finally {
        isIndexBuilding = false;
      }
    }

    // Debounce helper
    function debounce(fn, ms=200) {
      let t; 
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    // Render results (top 100)
    function renderResults(items) {
      if (!items.length) {
        resultsBox.style.display = 'none';
        resultsBox.innerHTML = '';
        return;
      }
      resultsBox.style.display = 'block';
      resultsBox.innerHTML = '';
      items.slice(0, 100).forEach(it => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = `${it.name}  (${it.state})`;
        btn.style.display = 'block';
        btn.style.width = '100%';
        btn.style.textAlign = 'left';
        btn.style.padding = '8px 10px';
        btn.style.margin = '4px 0';
        btn.style.background = '#294a38';
        btn.style.color = '#ddd';
        btn.style.border = 'none';
        btn.style.borderRadius = '6px';
        btn.style.cursor = 'pointer';
        btn.onmouseenter = () => btn.style.background = '#3f6d4e';
        btn.onmouseleave = () => btn.style.background = '#294a38';
        btn.addEventListener('click', () => chooseStationFromSearch(it));
        resultsBox.appendChild(btn);
      });
    }

    // Choose station from search: set state dropdown, load stations, set station, run your existing showChart()
    async function chooseStationFromSearch(item) {
      const stateSel = document.getElementById('state-select');
      const stationSel = document.getElementById('station-select');
      const searchBtn = document.getElementById('search-btn');

      // Set state and load its stations (uses your existing fetchStations via onchange)
      if (stateSel.value !== item.state) {
        stateSel.value = item.state;
        // call your existing function without editing it
        if (typeof fetchStations === 'function') {
          await fetchStations();
        } else {
          stateSel.dispatchEvent(new Event('change'));
        }
      }

      // Wait until the option exists (since fetchStations is async)
      await waitForOption(stationSel, item.id, 12000);

      // Set station and enable button
      stationSel.value = item.id;
      if (typeof stationSel.onchange === 'function') stationSel.onchange();
      if (searchBtn) searchBtn.disabled = false;

      // Hide results and clear search text
      resultsBox.style.display = 'none';
      resultsBox.innerHTML = '';
      searchInput.value = '';

      // Run your existing chart logic
      if (typeof showChart === 'function') showChart();
    }

    // Utility: wait for a specific option value to appear in a select
    function waitForOption(selectEl, value, timeoutMs=10000) {
      return new Promise((resolve, reject) => {
        const t0 = Date.now();
        const interval = setInterval(() => {
          const found = Array.from(selectEl.options).some(o => o.value === value);
          if (found) {
            clearInterval(interval);
            resolve(true);
          } else if (Date.now() - t0 > timeoutMs) {
            clearInterval(interval);
            reject(new Error('Option not found in time'));
          }
        }, 150);
      });
    }

    // Search behavior
    const handleSearch = debounce(() => {
      const q = (searchInput.value || '').trim().toLowerCase();
      if (!q) {
        resultsBox.style.display = 'none';
        resultsBox.innerHTML = '';
        return;
      }
      if (!isIndexReady) {
        // still building index â€” show a temporary status
        resultsBox.style.display = 'block';
        resultsBox.innerHTML = '<div style="padding:8px 10px; color:#ddd;">Building station indexâ€¦ keep typing.</div>';
      }
      const res = stationIndex.filter(s => s.name.toLowerCase().includes(q));
      renderResults(res);
    }, 180);

    // Kickoff index build on first focus/type, wire events
    searchInput.addEventListener('focus', buildGlobalIndex, { once: true });
    searchInput.addEventListener('input', () => { buildGlobalIndex(); handleSearch(); });

    // Close results if clicking outside
    document.addEventListener('click', (e) => {
      if (!document.getElementById('global-search-wrap').contains(e.target)) {
        resultsBox.style.display = 'none';
      }
    });
  </script>
  <!-- ðŸ”š ADDED -->
</body>
</html>

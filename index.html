<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>McCoy.fish</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      background-image: url('mccoyfishwallpaper.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      background-repeat: no-repeat;
      color: #d6d6d6;
    }
    header { text-align: center; padding-top: 40px; }
    header img { max-width: 160px; height: auto; }
    h1 { font-size: 3em; margin: 10px 0; color: #ccc; }
    main { padding: 20px; display: flex; flex-direction: column; align-items: center; }

    .search-section {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px;
      box-shadow: 0 0 20px #003300;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      margin-top: 20px;
    }
    .search-section h2 { text-align: center; font-size: 1.7em; color: #b8ffb3; margin-bottom: 20px; }
    .search-section input, .search-section select, .search-section button {
      width: 100%; padding: 12px; margin-top: 10px; margin-bottom: 15px;
      border-radius: 8px; border: none; font-size: 1em; background-color: #294a38; color: #ddd;
    }
    .search-section button { background-color: #3f6d4e; cursor: pointer; transition: background-color 0.3s ease; }
    .search-section button:hover { background-color: #51996b; }

    .gage-section {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px; box-shadow: 0 0 20px #003300;
      padding: 30px; width: 90%; max-width: 600px; margin-top: 20px; display: none;
    }
    .gage-section h2 { color: #b8ffb3; text-align: center; }

    .forecast-section {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px; box-shadow: 0 0 20px #003300;
      padding: 24px; width: 90%; max-width: 900px; margin-top: 20px; display: none;
    }
    .forecast-title { color: #b8ffb3; text-align: center; margin: 0 0 16px 0; font-size: 1.6em; }
    .forecast-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .forecast-card { background: rgba(41, 74, 56, 0.6); border: 1px solid rgba(184,255,179,0.15); border-radius: 12px; padding: 14px; }
    .forecast-card h4 { margin: 0 0 6px 0; color: #e1ffe0; font-weight: 600; font-size: 1.05em; }
    .forecast-line { margin: 4px 0; font-size: 0.95em; color: #dfe7df; }
    .forecast-narrative { margin-top: 14px; padding-top: 12px; border-top: 1px dashed rgba(184,255,179,0.25); color: #dfe7df; font-size: 0.98em; line-height: 1.35em; }

    /* Global search UI */
    .global-search-wrap { margin-top: 8px; }
    .global-results {
      background: rgba(41, 74, 56, 0.96); border: 1px solid rgba(184,255,179,0.25);
      box-shadow: 0 0 16px #003300; border-radius: 10px; max-height: 280px; overflow: auto; display: none;
    }
    .global-result-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(184,255,179,0.12); font-size: 0.95em; color: #e6ffe4; }
    .global-result-item:hover { background: rgba(81,153,107,0.25); }
    .global-results .empty { padding: 10px 12px; color: #dfe7df; opacity: 0.9; }
    .hint { font-size: 0.9em; color: #cfe9cc; opacity: 0.9; margin-top: -6px; margin-bottom: 10px; text-align: center; }
  </style>
</head>
<body>
  <header>
    <img src="mccoyfishlogo.png" alt="McCoy Fish Logo" />
    <h1>McCoy.fish</h1>
  </header>

  <main>
    <section class="search-section">
      <h2>Search Water Data</h2>

      <div class="global-search-wrap">
        <input id="global-search" type="text" placeholder="Type a river, creek, or station name from any state…" autocomplete="off">
        <div class="hint">Start typing to search every USGS station in every state. BE PATIENT AND WAIT MOMENTARILY AS RESULTS WILL UPDATE SLOWLY AS THEY BEGIN TO POPULATE. Select a result to auto load charts and weather.</div>
        <div id="global-results" class="global-results"></div>
      </div>

      <select id="state-select" onchange="fetchStations()">
        <option value="">Select a state</option>
        <option value="AL">Alabama</option><option value="AR">Arkansas</option><option value="AZ">Arizona</option>
        <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option>
        <option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option>
        <option value="IA">Iowa</option><option value="ID">Idaho</option><option value="IL">Illinois</option>
        <option value="IN">Indiana</option><option value="KS">Kansas</option><option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option><option value="MA">Massachusetts</option><option value="MD">Maryland</option>
        <option value="ME">Maine</option><option value="MI">Michigan</option><option value="MN">Minnesota</option>
        <option value="MO">Missouri</option><option value="MS">Mississippi</option><option value="MT">Montana</option>
        <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="NE">Nebraska</option>
        <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option>
        <option value="NV">Nevada</option><option value="NY">New York</option><option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option>
        <option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
        <option value="VA">Virginia</option><option value="VT">Vermont</option><option value="WA">Washington</option>
        <option value="WI">Wisconsin</option><option value="WV">West Virginia</option><option value="WY">Wyoming</option>
      </select>

      <select id="station-select" disabled>
        <option value="">Select a station</option>
      </select>

      <button onclick="showChart()" id="search-btn" disabled>Search</button>
    </section>

    <section class="gage-section" id="chart-section">
      <h2>Gage Height Chart</h2>
      <img id="usgs-chart-img" style="width: 100%; height: auto;" alt="USGS Gage Height Chart" />
      <h2 style="margin-top: 30px;">Discharge (CFS) – Last 7 Days</h2>
      <img id="usgs-discharge-img" style="width: 100%; height: auto;" alt="USGS Discharge Chart" />
    </section>

    <section class="forecast-section" id="forecast-section">
      <h3 class="forecast-title">3-Day Weather Forecast</h3>
      <div class="forecast-grid" id="forecast-grid"></div>
      <div class="forecast-narrative" id="forecast-narrative"></div>
    </section>
  </main>

  <!-- DROPDOWNS + CHARTS (unchanged) -->
  <script>
    async function fetchStations() {
      const state = document.getElementById("state-select").value;
      const stationSelect = document.getElementById("station-select");
      const searchBtn = document.getElementById("search-btn");

      stationSelect.innerHTML = '<option value="">Loading stations...</option>';
      stationSelect.disabled = true;
      searchBtn.disabled = true;

      if (!state) return;

      const response = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${state}&parameterCd=00065`);
      const text = await response.text();

      const lines = text.split('\n').filter(line => !line.startsWith('#') && line.trim() && !line.startsWith('agency_cd'));
      let stations = lines.map(line => {
        const parts = line.split('\t');
        return { id: parts[1], name: parts[2] };
      });

      stations.sort((a, b) => a.name.localeCompare(b.name));

      stationSelect.innerHTML = '<option value="">Select a station</option>';
      stations.forEach(station => {
        const option = document.createElement('option');
        option.value = station.id;
        option.textContent = station.name;
        stationSelect.appendChild(option);
      });

      stationSelect.disabled = false;
      stationSelect.onchange = () => {
        searchBtn.disabled = stationSelect.value === "";
      };
    }

    function showChart() {
      const siteId = document.getElementById("station-select").value;
      if (!siteId) return;

      const chartSection = document.getElementById("chart-section");
      chartSection.style.display = 'block';

      const today = new Date();
      const endDate = today.toISOString().split('T')[0];
      const past = new Date();
      past.setDate(today.getDate() - 7);
      const startDate = past.toISOString().split('T')[0];

      const chartImg = document.getElementById("usgs-chart-img");
      chartImg.src = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${siteId}&parm_cd=00065&period=7`;

      const dischargeImg = document.getElementById("usgs-discharge-img");
      dischargeImg.src = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${siteId}&parm_cd=00060&begin_date=${startDate}&end_date=${endDate}`;
    }
  </script>

  <!-- WEATHER (NWS forecast + sunrise/sunset; accurate timezone) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('search-btn');
      if (btn) btn.addEventListener('click', loadForecastForSelectedStation);
    });

    async function loadForecastForSelectedStation() {
      const siteId = document.getElementById('station-select').value;
      if (!siteId) return;

      const meta = await __getUsgsMeta(siteId);
      if (meta.lat == null || meta.lon == null) {
        showForecastError('Unable to determine station location for weather.');
        return;
      }

      try {
        await __renderForecastNWS(meta.lat, meta.lon);
      } catch (e) {
        console.warn('NWS render failed:', e);
        showForecastError('Weather forecast not available.');
      }
    }

    // Robust USGS site meta (expanded RDB preferred; JSON as fallback)
    async function __getUsgsMeta(siteId) {
      let meta = { lat:null, lon:null };
      try {
        const r = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rdb&sites=${siteId}&siteOutput=expanded`);
        const txt = await r.text();
        const header = txt.split("\n").find(L => L.startsWith("agency_cd"));
        const dataLine = txt.split("\n").find(L => L && !L.startsWith("#") && !L.startsWith("agency_cd"));
        if (header && dataLine) {
          const H = {}; header.split("\t").forEach((h,i)=>H[h]=i);
          const cols = dataLine.split("\t");
          const get = k => (H[k] != null ? cols[H[k]] : "");
          const la = parseFloat(get("dec_lat_va"));
          const lo = parseFloat(get("dec_long_va"));
          if (!isNaN(la) && !isNaN(lo)) { meta.lat = la; meta.lon = lo; }
        }
      } catch {}
      if (meta.lat == null || meta.lon == null) {
        try {
          const r2 = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=json&sites=${siteId}`);
          const j = await r2.json();
          const s = (j?.value?.site?.[0]) || (j?.value?.timeSeries?.[0]?.sourceInfo);
          const g = s?.geoLocation?.geogLocation;
          if (g?.latitude != null && g?.longitude != null) {
            meta.lat = g.latitude; meta.lon = g.longitude;
          }
        } catch {}
      }
      return meta;
    }

    // Format a Date (UTC) in a specific IANA timezone HH:MM
    function __fmtTimeInTZ(dateUTC, tz) {
      try {
        return new Intl.DateTimeFormat([], { hour:'2-digit', minute:'2-digit', timeZone: tz }).format(dateUTC);
      } catch { return '—'; }
    }

    async function __renderForecastNWS(lat, lon) {
      const section = document.getElementById('forecast-section');
      const grid = document.getElementById('forecast-grid');
      const narrative = document.getElementById('forecast-narrative');

      // 1) NWS gridpoint (gets timezone, location, and forecast URL)
      const ptRes = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
      const pt = await ptRes.json();
      const tz = pt?.properties?.timeZone || 'America/New_York';
      const city = pt?.properties?.relativeLocation?.properties?.city;
      const state = pt?.properties?.relativeLocation?.properties?.state;
      const locLabel = city && state ? `${city}, ${state}` : '';

      const forecastUrl = pt?.properties?.forecast;
      if (!forecastUrl) { showForecastError('Weather forecast not available.'); return; }

      // 2) 12-hour forecast periods from NWS
      const fRes = await fetch(forecastUrl);
      const fc = await fRes.json();
      const periods = fc?.properties?.periods || [];

      // Build next 3 day/night pairs
      let i = periods.findIndex(p => p.isDaytime === true);
      if (i < 0) i = 0;
      const days = [];
      while (i < periods.length && days.length < 3) {
        const day = periods[i];
        const night = periods[i+1] && periods[i+1].isDaytime === false ? periods[i+1] : null;

        const hi = day.temperatureUnit === 'F' ? day.temperature : Math.round(day.temperature * 9/5 + 32);
        const lo = night ? (night.temperatureUnit === 'F' ? night.temperature : Math.round(night.temperature * 9/5 + 32)) : null;
        const pop = Math.max(day.probabilityOfPrecipitation?.value ?? 0, night?.probabilityOfPrecipitation?.value ?? 0);

        days.push({
          dateISO: day.startTime,                     // e.g. 2025-09-15T06:00:00-04:00
          dateStr: day.startTime.slice(0,10),         // YYYY-MM-DD
          label: new Intl.DateTimeFormat([], { weekday:'short', month:'short', day:'numeric', timeZone: tz }).format(new Date(day.startTime)),
          hi, lo, sky: day.shortForecast, pop
        });
        i += night ? 2 : 1;
      }
      if (!days.length) { showForecastError('Weather forecast not available.'); return; }

      // 3) Sunrise/Sunset (UTC -> tz) using sunrise-sunset.org
      async function sunTimes(ymd) {
        try {
          const r = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${ymd}&formatted=0`);
          const j = await r.json();
          const sr = j?.results?.sunrise ? new Date(j.results.sunrise) : null;
          const ss = j?.results?.sunset ? new Date(j.results.sunset) : null;
          return {
            sunrise: sr ? __fmtTimeInTZ(sr, tz) : '—',
            sunset:  ss ? __fmtTimeInTZ(ss, tz) : '—'
          };
        } catch { return { sunrise: '—', sunset: '—' }; }
      }

      // 4) Render UI
      section.style.display = 'block';
      grid.innerHTML = '';
      const pieces = [];

      for (let k = 0; k < days.length; k++) {
        const d = days[k];
        const sun = await sunTimes(d.dateStr);

        grid.innerHTML += `
          <div class="forecast-card">
            <h4>${d.label}</h4>
            <div class="forecast-line">Sky: ${d.sky}</div>
            <div class="forecast-line">High / Low: ${d.hi}°F / ${d.lo ?? '—'}°F</div>
            <div class="forecast-line">Barometric Pressure: —</div>
            <div class="forecast-line">Sunrise: ${sun.sunrise} &nbsp;•&nbsp; Sunset: ${sun.sunset}</div>
            <div class="forecast-line">Precip: — in &nbsp; (Max Prob: ${Number.isFinite(d.pop) ? d.pop + '%' : '—'})</div>
          </div>
        `;

        pieces.push(`${k===0?'Today':k===1?'Tomorrow':d.label}: ${d.sky.toLowerCase()} with a high near ${d.hi}°F${d.lo!=null?` and a low around ${d.lo}°F`:''}. Max precip probability ${Number.isFinite(d.pop)?d.pop+'%':'N/A'}. Sunrise ${sun.sunrise}, sunset ${sun.sunset}.`);
      }

      const locText = locLabel ? ` near <strong>${locLabel}</strong>` : '';
      narrative.innerHTML = `<strong>Outlook${locText}:</strong> ${pieces.join(' ')}`;
    }

    function showForecastError(msg) {
      const section = document.getElementById('forecast-section');
      const grid = document.getElementById('forecast-grid');
      const narrative = document.getElementById('forecast-narrative');
      grid.innerHTML = '';
      narrative.innerHTML = msg || 'Weather unavailable.';
      section.style.display = 'block';
    }
  </script>

  <!-- GLOBAL SEARCH (unchanged behavior; we’ll optimize next) -->
  <script>
    const __ALL_STATES = ["AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY"];
    let __globalStations = []; let __globalIndexBuilt = false; let __buildingIndex = false;

    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('global-search');
      const box   = document.getElementById('global-results');
      if (!input || !box) return;

      input.addEventListener('focus', ensureGlobalIndex);
      input.addEventListener('input', () => { ensureGlobalIndex(); renderGlobalMatches(input.value.trim()); });

      document.addEventListener('click', (e) => { if (!box.contains(e.target) && e.target !== input) box.style.display = 'none'; });
    });

    async function ensureGlobalIndex() {
      if (__globalIndexBuilt || __buildingIndex) return;
      __buildingIndex = true;
      const resultsBox = document.getElementById('global-results');
      resultsBox.style.display = 'block';
      resultsBox.innerHTML = '<div class="empty">Building full USGS index…</div>';

      const batchSize = 6;
      const stateBatches = [];
      for (let i = 0; i < __ALL_STATES.length; i += batchSize) stateBatches.push(__ALL_STATES.slice(i, i + batchSize));

      try {
        for (const group of stateBatches) {
          await Promise.all(group.map(async (st) => {
            const url = `https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${st}&parameterCd=00065`;
            const res = await fetch(url);
            const text = await res.text();
            const lines = text.split('\n').filter(line => !line.startsWith('#') && line.trim() && !line.startsWith('agency_cd'));
            const rows = lines.map(line => { const p = line.split('\t'); return { id: p[1], name: p[2], state: st }; });
            __globalStations.push(...rows);
          }));
        }
        __globalStations.sort((a, b) => a.name.localeCompare(b.name));
        __globalIndexBuilt = true;
      } catch {
        resultsBox.innerHTML = '<div class="empty">Problem loading stations. Try again.</div>';
      } finally { __buildingIndex = false; }
    }

    function renderGlobalMatches(query) {
      const box = document.getElementById('global-results');
      if (!box) return;
      if (!query) { box.style.display = 'none'; return; }

      if (!__globalIndexBuilt) {
        box.style.display = 'block';
        box.innerHTML = '<div class="empty">Building full USGS index…</div>';
        return;
      }

      box.style.display = 'block';
      const q = query.toLowerCase();
      const matches = __globalStations.filter(s => (s.name || '').toLowerCase().includes(q)).slice(0, 80);

      if (!matches.length) { box.innerHTML = '<div class="empty">No matches. Refine your search.</div>'; return; }

      box.innerHTML = '';
      for (const m of matches) {
        const div = document.createElement('div');
        div.className = 'global-result-item';
        div.textContent = `${m.name}  [${m.state}]`;
        div.addEventListener('click', () => handleGlobalPick(m));
        box.appendChild(div);
      }
    }

    async function handleGlobalPick(station) {
      try {
        await loadStationsForState(station.state);
        const stationSelect = document.getElementById('station-select');
        const searchBtn = document.getElementById('search-btn');
        stationSelect.value = station.id;
        searchBtn.disabled = stationSelect.value === "";
        searchBtn.click();
      } catch {} finally {
        const box = document.getElementById('global-results'); if (box) box.style.display = 'none';
      }
    }

    async function loadStationsForState(state) {
      const stateSelect = document.getElementById('state-select');
      const stationSelect = document.getElementById('station-select');
      const searchBtn = document.getElementById('search-btn');

      if (stateSelect.value !== state) stateSelect.value = state;
      stationSelect.innerHTML = '<option value="">Loading stations...</option>';
      stationSelect.disabled = true; searchBtn.disabled = true;

      const response = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rdb&stateCd=${state}&parameterCd=00065`);
      const text = await response.text();
      const lines = text.split('\n').filter(line => !line.startsWith('#') && line.trim() && !line.startsWith('agency_cd'));
      let stations = lines.map(line => { const parts = line.split('\t'); return { id: parts[1], name: parts[2] }; });
      stations.sort((a, b) => a.name.localeCompare(b.name));

      stationSelect.innerHTML = '<option value="">Select a station</option>';
      stations.forEach(station => { const option = document.createElement('option'); option.value = station.id; option.textContent = station.name; stationSelect.appendChild(option); });

      stationSelect.disabled = false;
      stationSelect.onchange = () => { searchBtn.disabled = stationSelect.value === ""; };
      return true;
    }
  </script>
</body>
</html>

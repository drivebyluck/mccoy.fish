<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>McCoy.fish — Account</title>
  <style>
    /* ====== THEME (matches index.html visuals) ====== */
    body {
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      background-image: url('mccoyfishwallpaper.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      background-repeat: no-repeat;
      color: #d6d6d6;
    }
    header { text-align: center; padding-top: 40px; position: relative; }
    header img { max-width: 160px; height: auto; }

    /* Top-right Home button (matches your button styling) */
    .top-right-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background-color: #3f6d4e;
      color: #ddd;
      padding: 10px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.95em;
      display: inline-block;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .top-right-btn:hover { background-color: #51996b; }

    h1#page-title {
      font-size: 3em;
      margin: 10px 0;
      color: #ccc;
      text-align: center;
    }

    main { padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .card {
      background-color: rgba(0, 20, 10, 0.75);
      border-radius: 15px;
      box-shadow: 0 0 20px #003300;
      padding: 30px;
      width: 90%;
      max-width: 1100px;
      margin-top: 20px;
    }
    .card h2 { color: #b8ffb3; text-align: center; margin-top: 0; }

    .row { display: grid; gap: 16px; }
    .row.two { grid-template-columns: 1fr 1fr; }
    @media (max-width: 960px) { .row.two { grid-template-columns: 1fr; } }

    .inputs { max-width: 600px; margin: 0 auto; }
    .inputs input, .inputs button, .inputs textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      background-color: #294a38;
      color: #ddd;
      outline: none;
      box-sizing: border-box;
    }
    .inputs textarea { min-height: 120px; resize: vertical; }
    .inputs button {
      background-color: #3f6d4e;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .inputs button:hover { background-color: #51996b; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-secondary { background-color: #2d3f33 !important; }

    .notice {
      text-align: center;
      color: #e1ffe0;
      font-size: 0.95em;
      opacity: 0.95;
      margin-top: -4px;
      margin-bottom: 12px;
    }

    .favorites {
      background: rgba(41,74,56,0.96);
      border: 1px solid rgba(184,255,179,0.25);
      border-radius: 12px;
      padding: 14px;
      max-height: 360px;
      overflow: auto;
    }
    .fav-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      border-bottom: 1px solid rgba(184,255,179,0.12);
      padding: 10px 4px;
    }
    .fav-item:last-child { border-bottom: none; }
    .fav-title { font-weight: 600; color: #e6ffe4; }
    .fav-meta { font-size: 0.92em; color: #cfe9cc; opacity: 0.95; }
    .fav-actions { display: flex; gap: 8px; }
    .fav-actions button { padding: 8px 10px; }

    .linkbar { margin-top: 12px; text-align: center; font-size: 0.95em; }
    .linkbar a { color: #b8ffb3; text-decoration: none; }
    .linkbar a:hover { text-decoration: underline; }

    /* ====== Favorite Data Grid ====== */
    .favdata-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    .favdata {
      background: rgba(41, 74, 56, 0.96);
      border: 1px solid rgba(184,255,179,0.25);
      border-radius: 12px;
      padding: 14px;
    }
    .favdata h3 {
      margin: 0 0 8px 0;
      color: #e1ffe0;
      text-align: left;
      font-size: 1.05em;
    }
    .favdata .meta { font-size: 0.92em; color: #cfe9cc; margin-bottom: 8px; }
    .favdata .img-row img { width: 100%; height: auto; border-radius: 8px; background: rgba(0,0,0,0.15); }
    .favdata .wx { margin-top: 10px; font-size: 0.95em; color: #dfe7df; }
    .favdata .wx h4 { margin: 0 0 6px 0; color: #e1ffe0; font-size: 1.0em; }
    .forecast-line { margin: 4px 0; font-size: 0.95em; color: #dfe7df; }
    .forecast-split { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .wx-note { margin-top: 8px; border-top: 1px dashed rgba(184,255,179,0.25); padding-top: 8px; font-size: 0.95em; }

    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
    .toolbar button { padding: 8px 10px; }
    .small { font-size: 0.9em; opacity: 0.9; }

    .loader {
      font-size: 0.95em;
      color: #cfe9cc;
      text-align: left;
    }
    .bar-wrap {
      height: 6px; border-radius: 6px; background: rgba(184,255,179,0.18);
      overflow: hidden; box-shadow: inset 0 0 6px rgba(0,0,0,0.25); margin-top: 6px;
    }
    .bar {
      height: 100%; width: 40%; background: #b8ffb3; filter: drop-shadow(0 0 6px #003300);
      animation: indet 1.2s linear infinite;
    }
    @keyframes indet { 0%{margin-left:-45%} 100%{margin-left:105%} }

    /* ====== Search dropdown (same style as index) ====== */
    .results {
      display: none;
      background: rgba(41,74,56,0.96);
      border: 1px solid rgba(184,255,179,0.25);
      border-radius: 10px;
      max-height: 280px;
      overflow: auto;
    }
    .result-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(184,255,179,0.12);
      font-size: 0.95em;
      color: #e6ffe4;
    }
    .result-item:hover { background: rgba(81,153,107,0.25); }
    .muted { opacity: 0.85; }
  </style>
</head>
<body>
  <header>
    <img src="mccoyfishlogo.png" alt="McCoy Fish Logo" />
    <!-- Top-right Home button -->
    <a href="index.html" class="top-right-btn" title="Back to Home">Home</a>
  </header>

  <h1 id="page-title">Your Account</h1>

  <main>
    <!-- Auth Card -->
    <section id="auth-card" class="card">
      <h2 id="auth-heading">Sign In or Create an Account</h2>
      <div class="inputs" id="auth-forms">
        <div class="row two" id="auth-rows">
          <div>
            <h3 style="margin:0 0 8px 0; color:#e1ffe0; text-align:center;">Sign In</h3>
            <input id="in-email" type="email" placeholder="Email" autocomplete="email"/>
            <input id="in-pass" type="password" placeholder="Password" autocomplete="current-password"/>
            <button id="btn-signin">Sign In</button>
          </div>
          <div>
            <h3 style="margin:0 0 8px 0; color:#e1ffe0; text-align:center;">Create Account</h3>
            <input id="up-email" type="email" placeholder="Email" autocomplete="email"/>
            <input id="up-pass" type="password" placeholder="Password" autocomplete="new-password"/>
            <button id="btn-signup">Create Account</button>
          </div>
        </div>
        <div class="notice" id="auth-note">
          Accounts and favorites are stored locally in your browser for now.
        </div>
      </div>
      <div class="linkbar">
        <a href="index.html">Back to River Search</a>
      </div>
    </section>

    <!-- Account Dashboard -->
    <section id="acct-card" class="card" style="display:none;">
      <h2>Welcome, <span id="who"></span></h2>

      <div class="btn-row" style="justify-content:center; margin-bottom:6px;">
        <button id="btn-signout" title="Sign out of this device">Sign Out</button>
        <button id="btn-delete-user" class="btn-secondary" title="Remove account from this browser">Delete This Local Account</button>
      </div>
      <div class="notice">
        Favorites are saved to this browser under your email. Export before clearing storage or switching devices.
      </div>

      <div class="row two">
        <!-- Add Favorite -->
        <div>
          <h3 style="margin:0 0 8px 0; color:#e1ffe0; text-align:center;">Add Favorite Location</h3>
          <div class="inputs">
            <input id="fav-search" type="text" placeholder="Type a river, creek, or station name… (e.g., Licking River)" autocomplete="off" />
            <div id="fav-loader" class="loader" style="display:none;">
              Loading station index…
              <div class="bar-wrap"><div class="bar"></div></div>
            </div>
            <div id="fav-results" class="results"></div>

            <input id="fav-site" type="text" placeholder="USGS Site Number, 8 digits for example 03239500"/>
            <button id="btn-add-fav">Add to Favorites</button>
          </div>
          <div class="notice" style="text-align:left;">
            Tip: Use search above, pick a result (auto-fills the ID), then click “Add to Favorites”.
          </div>
        </div>

        <!-- Favorites List -->
        <div>
          <h3 style="margin:0 0 8px 0; color:#e1ffe0; text-align:center;">Your Favorites</h3>
          <div id="fav-list" class="favorites"></div>
          <div class="btn-row" style="margin-top:12px;">
            <button id="btn-export">Export JSON</button>
            <button id="btn-import" class="btn-secondary">Import JSON</button>
          </div>
          <div class="inputs" id="import-wrap" style="display:none;">
            <textarea id="import-json" placeholder='Paste favorites JSON here, then click "Apply Import"'></textarea>
            <div class="btn-row">
              <button id="btn-apply-import">Apply Import</button>
              <button id="btn-cancel-import" class="btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Favorite Locations Data -->
      <div id="fav-data-card" class="card" style="margin-top:24px; display:none;">
        <div class="toolbar">
          <h2 style="margin:0; flex:1 1 auto; text-align:left;">Favorite Locations Data</h2>
          <button id="btn-refresh-all">Refresh All</button>
          <span class="small" id="fav-count"></span>
        </div>
        <div class="favdata-grid" id="favdata-grid"></div>
      </div>

      <div class="linkbar">
        <a href="index.html">Back to River Search</a>
      </div>
    </section>
  </main>

  <!-- === Supabase config (your keys) === -->
  <script>
    window.SUPABASE_URL = "https://wzhvhhghjqzvarilcady.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6aHZoaGdoanF6dmFyaWxjYWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjI5ODcsImV4cCI6MjA3NjkzODk4N30.ed_U30NgYsSYxLJo-wd2Wryl8jlMRJxdWfiZfZU0zAg";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  </script>

  <script>
    /* ========= CONFIG ========= */
    const STATIONS_JSON_URL = '/data/stations.min.json'; // your local JSON index

    /* ====== Local storage keys ====== */
    const LS_USERS_KEY = 'mccoyfish_users_v1';
    const LS_SESSION_KEY = 'mccoyfish_session_v1';

    /* ====== State for stations ====== */
    let allStations = []; // {id, name, state, city?}
    let indexReady = false;

    /* Track last picked station name from search for auto-label */
    let lastPickedName = '';

    /* ====== Utilities ====== */
    function getUsers() { try { return JSON.parse(localStorage.getItem(LS_USERS_KEY)) || {}; } catch { return {}; } }
    function setUsers(users) { localStorage.setItem(LS_USERS_KEY, JSON.stringify(users)); }
    function getSession() { try { return JSON.parse(localStorage.getItem(LS_SESSION_KEY)) || null; } catch { return null; } }
    function setSession(obj) { localStorage.setItem(LS_SESSION_KEY, JSON.stringify(obj)); }
    function clearSession() { localStorage.removeItem(LS_SESSION_KEY); }

    function ensureLocalBucket(email) {
      const users = getUsers();
      if (!users[email]) {
        users[email] = { passHash: null, favorites: [] };
        setUsers(users);
      }
    }

    function normalizeSiteId(raw) {
      let s = (raw == null ? '' : String(raw)).trim().replace(/\D/g, '');
      if (s.length < 8) s = s.padStart(8, '0');
      return s;
    }
    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function weatherDescription(code) {
      const map = {0:"Clear",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",
        51:"Drizzle: Light",53:"Drizzle: Moderate",55:"Drizzle: Dense",56:"Freezing drizzle: Light",57:"Freezing drizzle: Dense",
        61:"Rain: Slight",63:"Rain: Moderate",65:"Rain: Heavy",66:"Freezing rain: Light",67:"Freezing rain: Heavy",
        71:"Snow: Slight",73:"Snow: Moderate",75:"Snow: Heavy",77:"Snow grains",
        80:"Rain showers: Slight",81:"Rain showers: Moderate",82:"Rain showers: Violent",
        85:"Snow showers: Slight",86:"Snow showers: Heavy",
        95:"Thunderstorm",96:"Thunderstorm with slight hail",99:"Thunderstorm with heavy hail"
      };
      return map[code] || "Unknown";
    }
    function parseCityFromName(name, st) {
      if (!name) return '';
      const m = name.match(/\b(?:AT|NEAR|NR|ABOVE|BELOW)\s+([^,]+),\s*([A-Z]{2})\b/i);
      if (m && (!st || m[2].toUpperCase() === st.toUpperCase())) {
        return m[1].trim().replace(/\s+/g,' ');
      }
      return '';
    }
    function makePrettyFromSiteName(siteName) {
      const m = siteName && siteName.match(/\b(?:AT|NEAR|NR|ABOVE|BELOW)\s+([^,]+),\s*([A-Z]{2})\b/i);
      if (m) return `${m[1].trim().replace(/\s+/g,' ')}, ${m[2].toUpperCase()}`;
      return siteName || '';
    }

    /* ====== DOM refs ====== */
    const authCard = document.getElementById('auth-card');
    const acctCard = document.getElementById('acct-card');
    const whoEl = document.getElementById('who');

    const inEmail = document.getElementById('in-email');
    const inPass  = document.getElementById('in-pass');
    const upEmail = document.getElementById('up-email');
    const upPass  = document.getElementById('up-pass');
    const btnSignin = document.getElementById('btn-signin');
    const btnSignup = document.getElementById('btn-signup');

    const btnSignout = document.getElementById('btn-signout');
    const btnDeleteUser = document.getElementById('btn-delete-user');

    const favSearch = document.getElementById('fav-search');
    const favLoader = document.getElementById('fav-loader');
    const favResults = document.getElementById('fav-results');

    const favSite  = document.getElementById('fav-site');
    const btnAddFav = document.getElementById('btn-add-fav');
    const favList = document.getElementById('fav-list');

    const btnExport = document.getElementById('btn-export');
    const btnImport = document.getElementById('btn-import');
    const importWrap = document.getElementById('import-wrap');
    const importJson = document.getElementById('import-json');
    const btnApplyImport = document.getElementById('btn-apply-import');
    const btnCancelImport = document.getElementById('btn-cancel-import');

    const favDataWrap = document.getElementById('fav-data-card');
    const favCountEl = document.getElementById('fav-count');
    const favGrid = document.getElementById('favdata-grid');
    const btnRefreshAll = document.getElementById('btn-refresh-all');

    /* ====== Boot ====== */
    async function loadIndex() {
      favLoader.style.display = 'block';
      try {
        const res = await fetch(STATIONS_JSON_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Stations JSON not found.');
        allStations = await res.json();
        if (!Array.isArray(allStations)) throw new Error('Stations JSON malformed.');

        for (const s of allStations) {
          s.id = normalizeSiteId(s.id ?? s.site_no ?? s.code ?? s.number);
          s.state = (s.state || '').toUpperCase();
          if (!s.city) s.city = parseCityFromName(s.name || '', s.state);
        }
        indexReady = true;
      } catch (e) {
        console.warn(e);
      } finally {
        favLoader.style.display = 'none';
      }
    }

    function showAuth() {
      authCard.style.display = 'block';
      acctCard.style.display = 'none';
      setTimeout(()=>inEmail.focus(), 50);
    }
    function showAccount(email) {
      whoEl.textContent = email;
      authCard.style.display = 'none';
      acctCard.style.display = 'block';
      ensureLocalBucket(email);
      renderFavorites(email);
      renderFavoriteData(email);
      importWrap.style.display = 'none';
      setTimeout(()=>favSearch.focus(), 50);
    }

    // === Supabase-backed auth handlers ===
    btnSignup.addEventListener('click', async () => {
      try {
        const email = (upEmail.value || '').trim().toLowerCase();
        const password  = upPass.value || '';
        if (!email || !password) { alert('Enter email and password.'); return; }
        const { error } = await sb.auth.signUp({ email, password });
        if (error) { alert('Sign up failed: ' + error.message); return; }
        setSession({ email });
        ensureLocalBucket(email);
        upEmail.value = ''; upPass.value = '';
        showAccount(email);
      } catch (err) {
        console.error(err);
        alert('Unable to create account. See console for details.');
      }
    });

    btnSignin.addEventListener('click', async () => {
      try {
        const email = (inEmail.value || '').trim().toLowerCase();
        const password  = inPass.value || '';
        if (!email || !password) { alert('Enter email and password.'); return; }
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) { alert('Sign in failed: ' + error.message); return; }
        setSession({ email });
        ensureLocalBucket(email);
        inEmail.value = ''; inPass.value = '';
        showAccount(email);
      } catch (err) {
        console.error(err);
        alert('Unable to sign in. See console for details.');
      }
    });

    btnSignout.addEventListener('click', async () => {
      await sb.auth.signOut();
      clearSession();
      showAuth();
    });

    sb.auth.onAuthStateChange((_event, session) => {
      const email = session?.user?.email || null;
      if (email) {
        setSession({ email });
        ensureLocalBucket(email);
        showAccount(email);
      } else {
        clearSession();
        showAuth();
      }
    });

    window.addEventListener('load', async () => {
      centerTitleBetweenLogoAndFirstCard();
      loadIndex(); // fire and forget
      const { data: { session} } = await sb.auth.getSession();
      const email = session?.user?.email || null;
      if (email) {
        setSession({ email });
        ensureLocalBucket(email);
        showAccount(email);
      } else {
        const sess = getSession();
        if (sess?.email && getUsers()[sess.email]) showAccount(sess.email);
        else showAuth();
      }
    });

    /* ====== Search-to-fill (like index.html) ====== */
    favSearch.addEventListener('input', () => {
      const q = favSearch.value.trim().toLowerCase();
      if (!indexReady || q.length < 2) { favResults.style.display = 'none'; return; }

      const hits = [];
      for (const s of allStations) {
        const hay = `${s.name || ''} ${s.city || ''} ${s.state || ''}`.toLowerCase();
        if (hay.includes(q)) hits.push(s);
        if (hits.length >= 120) break;
      }

      favResults.innerHTML = hits.map(s => {
        const cityPart = s.city ? ` • ${s.city}, ${s.state}` : ` • ${s.state}`;
        return `<div class="result-item" data-id="${s.id}" data-state="${s.state}" data-name="${escapeHTML(s.name || '')}">${escapeHTML(s.name || '')}<span class="muted">${cityPart}</span></div>`;
      }).join('') || `<div class="result-item muted">No matches.</div>`;
      favResults.style.display = 'block';
    });

    favResults.addEventListener('click', (e) => {
      const item = e.target.closest('.result-item[data-id]');
      if (!item) return;
      const id = item.getAttribute('data-id');
      const nm = item.getAttribute('data-name') || '';
      lastPickedName = nm || '';
      favSite.value  = id;
      favResults.style.display = 'none';
      btnAddFav.focus();
    });

    document.addEventListener('click', (e) => {
      if (!favResults.contains(e.target) && e.target !== favSearch) favResults.style.display='none';
    });

    /* ====== Favorites list UI ====== */
    btnAddFav.addEventListener('click', async () => {
      const sess = getSession(); if (!sess || !sess.email) return;
      const email = sess.email;

      let siteId = normalizeSiteId(favSite.value);
      if (!siteId || !/^\d{8}$/.test(siteId)) { alert('Enter a valid USGS site number.'); return; }

      // Derive label
      let label = (lastPickedName || '').trim();
      if (!label) label = await fetchSiteName(siteId);
      if (!label) label = `USGS ${siteId}`;

      const users = getUsers(); const u = users[email]; if (!u) return;
      if (u.favorites.some(f => f.siteId === siteId)) { alert('This site is already in your favorites.'); return; }
      u.favorites.push({ label, siteId, state: '', addedAt: new Date().toISOString() });
      setUsers(users);

      favSearch.value = '';
      favSite.value = '';
      lastPickedName = '';

      renderFavorites(email);
      renderFavoriteData(email, { fullReload: true });
    });

    async function fetchSiteName(siteId) {
      try {
        const sj = await (await fetch(`https://waterservices.usgs.gov/nwis/site/?format=json&sites=${siteId}`)).json();
        const s = (sj?.value?.site?.[0]) || (sj?.value?.timeSeries?.[0]?.sourceInfo);
        const siteName = s?.siteName || '';
        return siteName || '';
      } catch { return ''; }
    }

    function renderFavorites(email) {
      const users = getUsers(); const u = users[email]; if (!u) return;
      const list = u.favorites || [];
      if (!list.length) { favList.innerHTML = '<div style="opacity:0.9;">No favorites yet. Add one on the left.</div>'; return; }
      favList.innerHTML = list.map((f, idx) => {
        const meta = []; if (f.siteId) meta.push('USGS ' + f.siteId);
        return `
          <div class="fav-item" data-idx="${idx}">
            <div>
              <div class="fav-title">${escapeHTML(f.label)}</div>
              <div class="fav-meta">${meta.join(' • ')}</div>
            </div>
            <div class="fav-actions">
              <button data-act="copy" title="Copy site number">Copy ID</button>
              <button data-act="up" class="btn-secondary" title="Move up">Up</button>
              <button data-act="down" class="btn-secondary" title="Move down">Down</button>
              <button data-act="remove" class="btn-secondary" title="Remove favorite">Remove</button>
            </div>
          </div>
        `;
      }).join('');

      favList.querySelectorAll('.fav-item').forEach(el => {
        el.addEventListener('click', async (e) => {
          const act = e.target.getAttribute('data-act'); if (!act) return;
          const idx = parseInt(el.getAttribute('data-idx'), 10);
          const users2 = getUsers(); const u2 = users2[email]; if (!u2) return;

          if (act === 'remove') {
            const removed = u2.favorites.splice(idx, 1)[0];
            setUsers(users2);
            renderFavorites(email);
            removeFavoriteCard(removed);
            updateFavCount();
          } else if (act === 'up' || act === 'down') {
            const dir = act === 'up' ? -1 : 1;
            const j = idx + dir; if (j < 0 || j >= u2.favorites.length) return;
            const tmp = u2.favorites[idx]; u2.favorites[idx] = u2.favorites[j]; u2.favorites[j] = tmp;
            setUsers(users2);
            renderFavorites(email);
            renderFavoriteData(email, { fullReload: true });
          } else if (act === 'copy') {
            try { await navigator.clipboard.writeText(u2.favorites[idx].siteId || ''); alert('Site ID copied.'); }
            catch { alert('Copy failed.'); }
          }
        });
      });
    }

    /* ====== Favorite data rendering ====== */

    // Limit concurrent fetches to 3
    let activeLoads = 0;
    const pending = [];

    function queue(task) {
      pending.push(task);
      runNext();
    }
    function runNext() {
      if (activeLoads >= 3) return;
      const t = pending.shift();
      if (!t) return;
      activeLoads++;
      t().finally(() => {
        activeLoads--;
        runNext();
      });
    }

    function removeFavoriteCard(fav) {
      const card = document.querySelector(`[data-fav-key="${fav.siteId}"]`);
      if (card) card.remove();
      if (!favGrid.children.length) favDataWrap.style.display = 'none';
    }

    function updateFavCount() {
      const c = favGrid.children.length;
      favCountEl.textContent = c ? `${c} location${c===1?'':'s'}` : '';
      favDataWrap.style.display = c ? 'block' : 'none';
    }

    function renderFavoriteData(email, opts = {}) {
      const users = getUsers(); const u = users[email]; if (!u) return;
      const list = u.favorites || [];
      if (opts.fullReload) favGrid.innerHTML = '';
      if (!list.length) { favGrid.innerHTML = ''; updateFavCount(); return; }

      // Add cards that are missing
      for (const f of list) {
        const id = f.siteId;
        if (!document.querySelector(`[data-fav-key="${id}"]`)) {
          const card = document.createElement('div');
          card.className = 'favdata';
          card.setAttribute('data-fav-key', id);
          card.innerHTML = `
            <h3>${escapeHTML(f.label)}</h3>
            <div class="meta">USGS ${id}</div>
            <div class="toolbar" style="margin:6px 0 10px 0;">
              <button data-action="refresh" class="btn-secondary" title="Reload this location">Refresh</button>
            </div>
            <div class="img-row">
              <div class="loader">
                Loading charts...
                <div class="bar-wrap"><div class="bar"></div></div>
              </div>
              <img data-role="g65" alt="USGS Gage Height Chart" referrerpolicy="no-referrer" style="display:none; margin-top:6px;">
              <img data-role="g60" alt="USGS Discharge Chart" referrerpolicy="no-referrer" style="display:none; margin-top:10px;">
            </div>
            <div class="wx" data-role="wx">
              <h4>3-Day Weather</h4>
              <div class="loader">
                Fetching weather...
                <div class="bar-wrap"><div class="bar"></div></div>
              </div>
              <div data-role="wx-lines" style="display:none;"></div>
              <div class="wx-note" data-role="wx-note" style="display:none;"></div>
            </div>
          `;
          card.querySelectorAll('button[data-action]').forEach(btn => {
            btn.addEventListener('click', () => {
              const act = btn.getAttribute('data-action');
              if (act === 'refresh') {
                loadFavoriteCard(f, card, { force: true });
              }
            });
          });
          favGrid.appendChild(card);
        }
      }

      // Remove cards for deleted favorites
      Array.from(favGrid.children).forEach(el => {
        const key = el.getAttribute('data-fav-key');
        if (!list.some(f => f.siteId === key)) el.remove();
      });

      updateFavCount();

      // Lazy load cards as they enter viewport
      const io = new IntersectionObserver((entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            const card = entry.target;
            io.unobserve(card);
            const key = card.getAttribute('data-fav-key');
            const f = list.find(x => x.siteId === key);
            if (f) loadFavoriteCard(f, card);
          }
        }
      }, { rootMargin: '200px 0px' });

      document.querySelectorAll('.favdata').forEach(card => {
        io.observe(card);
      });

      if (list.length <= 2) {
        document.querySelectorAll('.favdata').forEach(card => {
          const key = card.getAttribute('data-fav-key');
          const f = list.find(x => x.siteId === key);
          if (f) loadFavoriteCard(f, card);
        });
      }
    }

    function loadFavoriteCard(fav, card, opts = {}) {
      const g65 = card.querySelector('[data-role="g65"]');
      const g60 = card.querySelector('[data-role="g60"]');
      const loaders = card.querySelectorAll('.img-row .loader');
      const wxBox = card.querySelector('[data-role="wx"]');
      const wxLines = card.querySelector('[data-role="wx-lines"]');
      const wxNote = card.querySelector('[data-role="wx-note"]');
      const wxLoader = wxBox.querySelector('.loader');

      // Charts with cache-buster + one retry
      queue(async () => {
        try {
          loaders.forEach(L => L.style.display = 'block');
          g65.style.display = 'none';
          g60.style.display = 'none';

          const today = new Date();
          const endDate = today.toISOString().split('T')[0];
          const past = new Date(); past.setDate(today.getDate() - 7);
          const startDate = past.toISOString().split('T')[0];

          const ts = Math.floor(Date.now() / 60000);
          const g65Url = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${fav.siteId}&parm_cd=00065&period=7&ts=${ts}`;
          const g60Url = `https://waterdata.usgs.gov/nwisweb/graph?agency_cd=USGS&site_no=${fav.siteId}&parm_cd=00060&begin_date=${startDate}&end_date=${endDate}&ts=${ts}`;

          g65.src = g65Url;
          g60.src = g60Url;

          await Promise.all([ensureImgShows(g65, g65Url), ensureImgShows(g60, g60Url)]);
        } finally {
          loaders.forEach(L => L.style.display = 'none');
          g65.style.display = 'block';
          g60.style.display = 'block';
        }
      });

      // Weather
      queue(async () => {
        try {
          wxLoader.style.display = 'block';
          wxLines.style.display = 'none';
          wxNote.style.display = 'none';

          const meta = await getUSGSCoordsRobust(fav.siteId);
          if (!meta) throw new Error('No coordinates');

          const url = new URL('https://api.open-meteo.com/v1/forecast');
          url.searchParams.set('latitude', meta.lat);
          url.searchParams.set('longitude', meta.lon);
          url.searchParams.set('timezone', 'auto');
          url.searchParams.set('temperature_unit', 'fahrenheit');
          url.searchParams.set('precipitation_unit', 'inch');
          url.searchParams.set('pressure_unit', 'hPa');
          url.searchParams.set('wind_speed_unit', 'mph');
          url.searchParams.set('forecast_days', '3');
          url.searchParams.set('daily', 'temperature_2m_max,temperature_2m_min,sunrise,sunset,weathercode,precipitation_probability_max,precipitation_sum,wind_speed_10m_max');
          url.searchParams.set('hourly', 'pressure_msl');

          const r = await fetch(url.toString());
          const data = await r.json();
          const pTimes = data?.hourly?.time || [];
          const pVals  = data?.hourly?.pressure_msl || [];
          const avgInHg = (data?.daily?.time || []).map(dayStr => {
            let total=0, cnt=0;
            for (let i=0;i<pTimes.length;i++) if (pTimes[i].startsWith(dayStr)) { total+=pVals[i]; cnt++; }
            const hPa = cnt ? total/cnt : null;
            return hPa ? (hPa/33.8639).toFixed(2) : '—';
          });

          const { time, temperature_2m_max: tMax, temperature_2m_min: tMin,
                  sunrise, sunset, weathercode: wCode, precipitation_probability_max: pProb,
                  precipitation_sum: pSum, wind_speed_10m_max: windMax } = data.daily;

          const pieces = [];
          const lines = [];
          for (let i=0;i<time.length;i++) {
            const dateLabel = new Date(time[i]).toLocaleDateString([], { weekday:'short', month:'short', day:'numeric' });
            const desc = weatherDescription(wCode[i]);
            const hi = Math.round(tMax[i]);
            const lo = Math.round(tMin[i]);
            const prob = (pProb?.[i] ?? '—');
            const precip = (pSum?.[i] ?? '—');
            const wind = (windMax?.[i] ?? '—');
            lines.push(`
              <div class="forecast-line"><strong>${dateLabel}</strong> • ${desc} • High ${hi}°F / Low ${lo}°F • Pressure ${avgInHg[i]} inHg • Wind ${wind==='—'?'—':wind+' mph'} • Precip ${precip} in (Max Prob ${prob==='—'?'—':prob+'%'})</div>
            `);
            pieces.push(`${i===0?'Today':i===1?'Tomorrow':dateLabel}: ${desc.toLowerCase()} high near ${hi}°F, low around ${lo}°F, avg pressure ~${avgInHg[i]} inHg, wind up to ${wind==='—'?'N/A':wind+' mph'}, precip ${precip} in (max prob ${prob==='—'?'N/A':prob+'%'}).`);
          }

          wxLines.innerHTML = lines.join('');
          wxNote.innerHTML = `<strong>Outlook${meta.pretty ? ' near ' + meta.pretty : ''}:</strong> ${pieces.join(' ')}`;

          wxLoader.style.display = 'none';
          wxLines.style.display = 'block';
          wxNote.style.display = 'block';
        } catch (e) {
          wxLoader.textContent = 'Weather forecast not available.';
        }
      });
    }

    // Wait for load/error; if blank, retry once with a fresh cache-buster
    async function ensureImgShows(img, baseUrl) {
      await imgReady(img);
      if (!img.naturalWidth) {
        await new Promise(r => setTimeout(r, 150));
        img.src = `${baseUrl}&r=${Date.now()}`;
        await imgReady(img);
      }
    }

    function imgReady(img) {
      return new Promise(res => {
        if (img.complete) return res();
        const on = () => { cleanup(); res(); };
        const cleanup = () => { img.removeEventListener('load', on); img.removeEventListener('error', on); };
        img.addEventListener('load', on); img.addEventListener('error', on);
      });
    }

    async function getUSGSCoordsRobust(siteId) {
      const ok = (lat, lon) => lat!=null && lon!=null && isFinite(lat) && isFinite(lon) &&
                               lat >= 24 && lat <= 50 && lon <= -66 && lon >= -125;
      try {
        const iv = await (await fetch(`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${siteId}`)).json();
        const ts = iv?.value?.timeSeries?.[0]?.sourceInfo;
        const g  = ts?.geoLocation?.geogLocation;
        const lat = g?.latitude, lon = g?.longitude;
        const siteName = ts?.siteName || '';
        if (ok(lat, lon)) return { lat, lon, siteName, pretty: makePrettyFromSiteName(siteName) };
      } catch {}
      try {
        const sj = await (await fetch(`https://waterservices.usgs.gov/nwis/site/?format=json&sites=${siteId}`)).json();
        const s = (sj?.value?.site?.[0]) || (sj?.value?.timeSeries?.[0]?.sourceInfo);
        const g = s?.geoLocation?.geogLocation;
        const lat = g?.latitude, lon = g?.longitude;
        const siteName = s?.siteName || '';
        if (ok(lat, lon)) return { lat, lon, siteName, pretty: makePrettyFromSiteName(siteName) };
      } catch {}
      try {
        const rdb = await (await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rdb&sites=${siteId}&siteOutput=expanded`)).text();
        const header = rdb.split("\n").find(L => L.startsWith("agency_cd"));
        const dataLine = rdb.split("\n").find(L => L && !L.startsWith("#") && !L.startsWith("agency_cd"));
        if (header && dataLine) {
          const H = {}; header.split("\t").forEach((h,i)=>H[h]=i);
          const cols = dataLine.split("\t");
          const get = k => (H[k]!=null?cols[H[k]]:"");
          const lat = parseFloat(get("dec_lat_va"));
          const lon = parseFloat(get("dec_long_va"));
          const siteName = get("station_nm") || '';
          if (ok(lat, lon)) return { lat, lon, siteName, pretty: makePrettyFromSiteName(siteName) };
        }
      } catch {}
      return null;
    }

    /* ====== EXPORT / IMPORT (wired up) ====== */
    btnExport.addEventListener('click', () => {
      const sess = getSession();
      if (!sess || !sess.email) { alert('Please sign in first.'); return; }
      const users = getUsers(); const u = users[sess.email];
      if (!u) { alert('No data for this account.'); return; }
      const payload = {
        email: sess.email,
        exportedAt: new Date().toISOString(),
        favorites: Array.isArray(u.favorites) ? u.favorites : []
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mccoyfish-favorites-${sess.email.replace(/[^a-z0-9]+/gi,'_')}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => {
      importWrap.style.display = 'block';
      importJson.value = '';
      importJson.focus();
    });

    btnCancelImport.addEventListener('click', () => {
      importWrap.style.display = 'none';
      importJson.value = '';
    });

    btnApplyImport.addEventListener('click', async () => {
      const sess = getSession();
      if (!sess || !sess.email) { alert('Please sign in first.'); return; }
      let data = null;
      try {
        data = JSON.parse(importJson.value);
      } catch {
        alert('Invalid JSON.');
        return;
      }
      if (!data || !Array.isArray(data.favorites)) {
        alert('JSON must include a "favorites" array.');
        return;
      }
      const users = getUsers(); const u = users[sess.email]; if (!u) return;

      const incoming = data.favorites
        .map(f => ({
          label: String(f.label || '').trim(),
          siteId: normalizeSiteId(f.siteId || ''),
          state: String(f.state || '').trim().toUpperCase(),
          addedAt: f.addedAt || new Date().toISOString()
        }))
        .filter(f => f.siteId && /^\d{8}$/.test(f.siteId));

      // If any labels missing, try to fetch them (best-effort)
      for (const f of incoming) {
        if (!f.label) {
          const name = await fetchSiteName(f.siteId);
          f.label = name || `USGS ${f.siteId}`;
        }
      }

      const existing = new Set((u.favorites || []).map(x => x.siteId));
      for (const f of incoming) if (!existing.has(f.siteId)) { u.favorites.push(f); existing.add(f.siteId); }

      setUsers(users);
      renderFavorites(sess.email);
      renderFavoriteData(sess.email, { fullReload: true });

      importWrap.style.display = 'none';
      importJson.value = '';
      alert('Import complete.');
    });

    /* ====== Title centering (match index) ====== */
    function centerTitleBetweenLogoAndFirstCard() {
      const GAP = 24;
      const logo   = document.querySelector('header img');
      const title  = document.getElementById('page-title');
      const first  = document.querySelector('main .card');
      if (!logo || !title || !first) return;
      const logoBottom = logo.getBoundingClientRect().bottom + window.scrollY;
      const firstTop   = first.getBoundingClientRect().top + window.scrollY;
      const titleH     = title.getBoundingClientRect().height || 0;
      const total      = Math.max(firstTop - logoBottom, GAP*2 + titleH);
      const freeSpace  = total - titleH;
      const half       = Math.max(GAP, freeSpace / 2);
      title.style.marginTop = half + 'px';
      title.style.marginBottom = half + 'px';
    }
    window.addEventListener('resize', centerTitleBetweenLogoAndFirstCard);
  </script>
</body>
</html>

